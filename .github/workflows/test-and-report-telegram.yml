name: Critical Flows Test & Telegram Report

on:
  # Ejecutar cada lunes a las 9 AM
  schedule:
    - cron: '0 9 * * 1'
  
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:
  
  # Ejecutar en cada push a main (opcional)
  # push:
  #   branches: [ main ]

jobs:
  test-and-report:
    name: Test System & Send Report
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install scikit-learn numpy pandas python-telegram-bot
      
      - name: ğŸ§ª Run critical flows tests
        id: tests
        run: |
          python test_critical_flows.py
          echo "test_status=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: ğŸ“Š Generate test summary
        if: always()
        run: |
          if [ -f "data/output/critical_flows_report.json" ]; then
            echo "âœ… Test report generated"
            cat data/output/telegram_report.txt
          else
            echo "âŒ Test report not found"
          fi
      
      - name: ğŸ“± Send report to Telegram
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python send_to_telegram.py
      
      - name: ğŸ“‹ Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            data/output/telegram_*.txt
            data/output/critical_flows_report.json
          retention-days: 30
      
      - name: âœ… Mark as successful
        if: steps.tests.outputs.test_status == '0'
        run: echo "âœ… All tests passed successfully"
      
      - name: âš ï¸ Mark as warning
        if: steps.tests.outputs.test_status != '0'
        run: |
          echo "âš ï¸ Some tests failed or had warnings"
          exit 0  # Don't fail the workflow
